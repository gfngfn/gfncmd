\def\decosep{\par\indent}
\def\newdecoclass#1#2#3#4{%
  % ---- ---- ---- ----
  % #1 : class name
  % #2 : prefix
  % #3 : style
  % #4 : counter
  % ---- ---- ---- ----
  \long\def#1{%
    \def\gfndeco@selectbyoption{%
      \ifx[\gfndeco@maybeoption
        \def\gfndeco@selected{\csname gfndeco@labeled@#3\endcsname{#4}{#2}}%
      \else
        \ifx*\gfndeco@maybeoption
          \def\gfndeco@selected{\csname gfndeco@nonumber@#3\endcsname{#2}}%
        \else
          \def\gfndeco@selected{\csname gfndeco@number@#3\endcsname{#4}{#2}}%
        \fi
      \fi
      \gfndeco@selected
    }%
    \futurelet\gfndeco@maybeoption\gfndeco@selectbyoption
  }%
}
\def\newnonumberdecoclass#1#2#3{%
  % ---- ---- ---- ----
  % #1 : class name
  % #2 : prefix
  % #3 : style
  % ---- ---- ---- ----
  \long\def#1{\csname gfndeco@nonumber@#3\endcsname{#2}*}%
}
%
\def\gfndeco@unique{\gfndeco@uniquesub}
\def\gfndeco@ifempty#1#2#3{%
  \ifx\gfndeco@unique#1\gfndeco@unique#2\else#3\fi
}
  % ---- gfndeco@nonumber@xxx ----
  % #1 : prefix, #2 : title, #3 : content
  % ---- ---- ---- ----
  % ---- gfndeco@number@xxx ----
  % #1 : counter, #2 : prefix, #3 : title, #4 : content
  % ---- ---- ---- ----
  % ---- gfndeco@labeled@xxx ----
  % #1 : counter, #2 : prefix, #3 : label, #4 : title, #5 : content
  % ---- ---- ---- ----
%
% ---- 'square' style ----
\long\def\gfndeco@nonumber@square#1*#2#3{%
  \noindent\fbox{\textsf{#1}}\textsf{\gfndeco@ifempty{#2}{}{\gfndeco@ifempty{#1}{}{\enskip}#2}}%
  \quad\ignorespaces#3\par
}
\long\def\gfndeco@number@square#1#2#3#4{%
  \refstepcounter{#1}%,
  \noindent\fbox{\textsf{#2\csname the#1\endcsname}}\textsf{\gfndeco@ifempty{#3}{}{\gfndeco@ifempty{#2}{}{\enskip}#3}}%
  \quad\ignorespaces#4\par
}
\long\def\gfndeco@labeled@square#1#2[#3]#4#5{%
  \refstepcounter{#1}\label{#3}%
  \noindent\fbox{\textsf{#2\csname the#1\endcsname}}\textsf{\gfndeco@ifempty{#4}{}{\gfndeco@ifempty{#2}{}{\enskip}#4}}%
  \quad\ignorespaces#5\par
}
% ---- 'top' style ----
\long\def\gfndeco@nonumber@top#1*#2#3{%
  \noindent\textsf{#1\gfndeco@ifempty{#2}{}{\gfndeco@ifempty{#1}{}{\enskip}#2}}%
  \quad\ignorespaces#3\par
}
\long\def\gfndeco@number@top#1#2#3#4{%
  \refstepcounter{#1}%,
  \noindent\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#3}{}{\gfndeco@ifempty{#2}{}{\enskip}#3}}%
  \quad\ignorespaces#4\par
}
\long\def\gfndeco@labeled@top#1#2[#3]#4#5{%
  \refstepcounter{#1}\label{#3}%
  \noindent\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#4}{}{\gfndeco@ifempty{#2}{}{\enskip}#4}}%
  \quad\ignorespaces#5\par
}
% ---- 'topwithbottom' style ----
\long\def\gfndeco@nonumber@topwithbottom#1*#2#3{%
  \noindent\textsf{#1\gfndeco@ifempty{#2}{}{\gfndeco@ifempty{#1}{}{\enskip}#2}}%
  \quad\ignorespaces#3\par\nopagebreak\vspace{-\parskip}\vspace{-0.25em}
  \noindent
  \begin{tikzpicture}
    \draw[line width=1pt, dotted] (0,0) -- (0.99\textwidth,0);
  \end{tikzpicture}%
  \par
}
\long\def\gfndeco@number@topwithbottom#1#2#3#4{%
  \refstepcounter{#1}%,
  \noindent\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#3}{}{\gfndeco@ifempty{#2}{}{\enskip}#3}}%
  \quad\ignorespaces#4\par\nopagebreak\vspace{-\parskip}\vspace{-0.25em}
  \noindent
  \begin{tikzpicture}
    \draw[line width=1pt, dotted] (0,0) -- (0.99\textwidth,0);
  \end{tikzpicture}%
  \par
}
\long\def\gfndeco@labeled@topwithbottom#1#2[#3]#4#5{%
  \refstepcounter{#1}\label{#3}%
  \noindent\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#4}{}{\gfndeco@ifempty{#2}{}{\enskip}#4}}%
  \quad\ignorespaces#5\par\nopagebreak\vspace{-\parskip}\vspace{-0.25em}
  \noindent
  \begin{tikzpicture}
    \draw[line width=1pt, dotted] (0,0) -- (0.99\textwidth,0);
  \end{tikzpicture}%
  \par
}
% ---- 'std' style ----
\long\def\gfndeco@nonumber@std#1*#2#3{%
  \noindent\textsf{#1\gfndeco@ifempty{#1}{}{\enskip}#2}\par
  \nopagebreak\vspace{-\parskip}\indent\ignorespaces#3\par
    %(it seems that \nopagebreak should be immediately after \par)
}
\long\def\gfndeco@number@std#1#2#3#4{%
  \refstepcounter{#1}%
  \noindent\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#3}{}{\gfndeco@ifempty{#2}{}{\enskip}#3}}\par
  \nopagebreak\vspace{-\parskip}\indent\ignorespaces#4\par
}
\long\def\gfndeco@labeled@std#1#2[#3]#4#5{%
  \refstepcounter{#1}\label{#3}%
  \noindent\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#4}{}{\gfndeco@ifempty{#2}{}{\enskip}#4}}\par
  \nopagebreak\vspace{-\parskip}\indent\ignorespaces#5\par
}
% ---- 'ul' style ----
\long\def\gfndeco@nonumber@ul#1*#2#3{%
  \noindent\underline{\textsf{#1\gfndeco@ifempty{#2}{}{\gfndeco@ifempty{#1}{}{\enskip}#2}}}\par
  \nopagebreak\vspace{-\parskip}\indent\ignorespaces#3\par
}
\long\def\gfndeco@number@ul#1#2#3#4{%
  \refstepcounter{#1}%
  \noindent\underline{\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#3}{}{\gfndeco@ifempty{#2}{}{\enskip}#3}}}\par
  \nopagebreak\vspace{-\parskip}\indent\ignorespaces#4\par
}
\long\def\gfndeco@labeled@ul#1#2[#3]#4#5{%
  \refstepcounter{#1}\label{#3}%
  \noindent\underline{\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#4}{}{\gfndeco@ifempty{#2}{}{\enskip}#4}}}\par
  \nopagebreak\vspace{-\parskip}\indent\ignorespaces#5\par
}
% ---- 'box' style ----
\long\def\gfndeco@nonumber@box#1*#2#3{%
  \noindent
  \begin{itembox}[l]{\textsf{#1\gfndeco@ifempty{#2}{}{\gfndeco@ifempty{#1}{}{\enskip}#2}}}
    \ignorespaces#3%
  \end{itembox}\par
}
\long\def\gfndeco@number@box#1#2#3#4{%
  \refstepcounter{#1}%
  \noindent
  \begin{itembox}[l]{\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#3}{}{\gfndeco@ifempty{#2}{}{\enskip}#3}}}%
    \ignorespaces#4%
  \end{itembox}\par
}
\long\def\gfndeco@labeled@box#1#2[#3]#4#5{%
  \refstepcounter{#1}\label{#3}%
  \noindent
  \begin{itembox}[l]{\textsf{#2\csname the#1\endcsname\gfndeco@ifempty{#4}{}{\gfndeco@ifempty{#2}{}{\enskip}#4}}}%
    \ignorespaces#5%
  \end{itembox}\par
}
