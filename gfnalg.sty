%\def\IF{\futurelet\gfnalg@nextchar\gfnalg@ifsub}
%\def\gfnalg@ifsub{%
%  \ifx\gfnalg@nextchar*\let\gfnalg@ifchoose\gfnalg@if@star\else\fi}
\newbox\gfnalg@box@temp
\newdimen\gfnalg@dimen@condheight
\newdimen\gfnalg@dimen@blockheight
\newdimen\gfnalg@dimen@blockdepth
\newdimen\gfnalg@dimen@linesepr
\newdimen\gfnalg@dimen@currentwidth
\gfnalg@dimen@linesepr=1em\relax
\long\def\algorithm#1{%
  {%
    %(--
      \parskip=0pt\relax
      \fboxrule=0pt\relax
      \fboxsep=0pt\relax
      \gfnalg@dimen@currentwidth=0.85\textwidth\relax
    %--)
    \begin{center}
      \begin{tabular}{l}
      \hline
        \parbox{0.9\textwidth}{#1}%
      \\\hline
      \end{tabular}
    \end{center}
  }%
}
\long\def\gfnalg@doubleblock#1#2#3{%
  %(-- measure height of conditional expression --
    \setbox0=\hbox{\fbox{#1}}%
    \gfnalg@dimen@condheight=\ht0\relax\advance\gfnalg@dimen@condheight by\dp0\relax
  %--)
  \underline{\hspace{0.125em}}\gfnalg@tokenstyle{if}\enskip#1\enskip\gfnalg@tokenstyle{then}\par
  %(-- measure height of true block
    \setbox\gfnalg@box@temp=\hbox{\fbox{\parbox[b]{\textwidth}{#2}}}%(width needs fixing)
    \gfnalg@dimen@blockheight=\ht\gfnalg@box@temp\relax
    \gfnalg@dimen@blockdepth=\dp\gfnalg@box@temp\relax
    \advance\gfnalg@dimen@blockheight by\gfnalg@dimen@blockdepth\relax
    \advance\gfnalg@dimen@currentwidth by-\gfnalg@dimen@linesepr\relax
    \setbox\gfnalg@box@temp=\hbox{\parbox[b]{\gfnalg@dimen@currentwidth}{#2}}%(width needs fixing)
    \advance\gfnalg@dimen@currentwidth by\gfnalg@dimen@linesepr\relax
    \advance\gfnalg@dimen@blockheight by0.5em\relax
  %--)
  \hspace{-\arrayrulewidth}%
  \rule[-\gfnalg@dimen@blockdepth]{0pt}{\gfnalg@dimen@blockheight}%
  %(--
    %\advance\gfnalg@dimen@blockheight by-0.5em\relax
    \advance\gfnalg@dimen@blockheight by\gfnalg@dimen@condheight\relax
  %--)
  \smash{\rule[-\gfnalg@dimen@blockdepth]{\arrayrulewidth}{\gfnalg@dimen@blockheight}}%
  \hspace{\gfnalg@dimen@linesepr}%
  \box\gfnalg@box@temp\par
  \underline{\hspace{0.125em}}\gfnalg@tokenstyle{else}\par
  %(-- measure height of false block
    \setbox\gfnalg@box@temp=\hbox{\fbox{\parbox[b]{\textwidth}{#3}}}%
    \gfnalg@dimen@blockheight=\ht\gfnalg@box@temp\relax
    \gfnalg@dimen@blockdepth=\dp\gfnalg@box@temp\relax
    \advance\gfnalg@dimen@blockheight by\gfnalg@dimen@blockdepth\relax
    \advance\gfnalg@dimen@currentwidth by-\gfnalg@dimen@linesepr\relax
    \setbox\gfnalg@box@temp=\hbox{\parbox[b]{\gfnalg@dimen@currentwidth}{#3}}%
    \advance\gfnalg@dimen@currentwidth by\gfnalg@dimen@linesepr\relax
    \advance\gfnalg@dimen@blockheight by0.5em\relax
  %--)
  \hspace{-\arrayrulewidth}%
  \rule[-\gfnalg@dimen@blockdepth]{0pt}{\gfnalg@dimen@blockheight}%
  %(--
    \advance\gfnalg@dimen@blockheight by2.55em\relax
    \advance\gfnalg@dimen@blockdepth by0.55em\relax
  %--)
  \smash{\rule[-\gfnalg@dimen@blockdepth]{\arrayrulewidth}{\gfnalg@dimen@blockheight}}%
  \rlap{\rule[-\gfnalg@dimen@blockdepth]{0.5em}{\arrayrulewidth}}%
  \hspace{\gfnalg@dimen@linesepr}%
  \box\gfnalg@box@temp\par\vspace{0.25em}%
}
\long\def\gfnalg@singleblock#1#2#3#4{%
  %(-- measure height of conditional expression --
    \setbox0=\hbox{\fbox{#1}}%
    \gfnalg@dimen@condheight=\ht0\relax\advance\gfnalg@dimen@condheight by\dp0\relax
  %--)
  \underline{\hspace{0.125em}}#3\enskip#1\enskip#4\par
  %(-- measure height of true block
    \setbox\gfnalg@box@temp=\hbox{\fbox{\parbox[b]{\textwidth}{#2}}}%(width needs fixing)
    \gfnalg@dimen@blockheight=\ht\gfnalg@box@temp\relax
    \gfnalg@dimen@blockdepth=\dp\gfnalg@box@temp\relax
    \advance\gfnalg@dimen@blockheight by\gfnalg@dimen@blockdepth\relax
    \advance\gfnalg@dimen@currentwidth by-\gfnalg@dimen@linesepr\relax
    \setbox\gfnalg@box@temp=\hbox{\parbox[b]{\gfnalg@dimen@currentwidth}{#2}}%(width needs fixing)
    \advance\gfnalg@dimen@currentwidth by\gfnalg@dimen@linesepr\relax
    \advance\gfnalg@dimen@blockheight by0.5em\relax
  %--)
  \hspace{-\arrayrulewidth}%
  \rule[-\gfnalg@dimen@blockdepth]{0pt}{\gfnalg@dimen@blockheight}%
  %(--
    %\advance\gfnalg@dimen@blockheight by-0.5em\relax
    \advance\gfnalg@dimen@blockheight by\gfnalg@dimen@condheight\relax
    \advance\gfnalg@dimen@blockheight by0.55em\relax
    \advance\gfnalg@dimen@blockdepth by0.55em\relax
  %--)
  \smash{\rule[-\gfnalg@dimen@blockdepth]{\arrayrulewidth}{\gfnalg@dimen@blockheight}}%
  \rlap{\rule[-\gfnalg@dimen@blockdepth]{0.5em}{\arrayrulewidth}}%
  \hspace{\gfnalg@dimen@linesepr}%
  \box\gfnalg@box@temp\par\vspace{0.25em}%
}
\def\ELSE{\gfncld@elsetokensub}
\long\def\IF#1\THEN#2{%
  \def\gfnalg@condcontent{#1}%
  \def\gfnalg@trueblockcontent{#2}%
  \futurelet\gfnalg@nexttoken\gfnalg@ifsub
}
\long\def\IFX#1\THEN#2\ELSE#3{\gfnalg@doubleblock{$#1$}{#2}{#3}}
\def\gfnalg@ifsub{%
  \ifx\gfnalg@nexttoken\ELSE
    \expandafter\gfnalg@ifsub@else
  \else
    \expandafter\gfnalg@ifsub@noelse
  \fi
}
\long\def\gfnalg@ifsub@else\ELSE#1{%
  \gfnalg@doubleblock{$\displaystyle\gfnalg@condcontent$}{\gfnalg@trueblockcontent}{#1}%
}
\def\gfnalg@ifsub@noelse{%
  \gfnalg@singleblock{$\displaystyle\gfnalg@condcontent$}{\gfnalg@trueblockcontent}{\gfnalg@tokenstyle{if}}{\gfnalg@tokenstyle{then}}%
}
\def\gfnalg@tokenstyle#1{\underline{\textbf{#1}}}
\long\def\WHILE#1#2{\gfnalg@singleblock{$\displaystyle#1$}{#2}{\gfnalg@tokenstyle{while}}{\gfnalg@tokenstyle{do}}}
\long\def\FORSUBST#1#2#3{\gfnalg@singleblock{$\displaystyle#1 \leftarrow #2$}{#3}{\gfnalg@tokenstyle{for}}{\gfnalg@tokenstyle{do}}}
\long\def\FORIN#1#2#3{\gfnalg@singleblock{$\displaystyle#1 \in #2$}{#3}{\gfnalg@tokenstyle{for}}{\gfnalg@tokenstyle{do}}}
\long\def\LETIN#1#2#3{\gfnalg@singleblock{$\displaystyle#1 \defeq #2$}{#3}{\gfnalg@tokenstyle{let}}{\gfnalg@tokenstyle{in}}}
\long\def\LETFUNC#1#2#3{\gfnalg@singleblock{$\displaystyle#1\paren{#2}$}{#3}{\gfnalg@tokenstyle{let}}{{$\defeq$}}}
\long\def\MATCH#1#2{\gfnalg@singleblock{$\displaystyle#1$}{#2}{\gfnalg@tokenstyle{match}}{\gfnalg@tokenstyle{with}}}
\long\def\CASE#1#2{\gfnalg@singleblock{$\displaystyle#1$}{#2}{\gfnalg@tokenstyle{case}}{{$\rightarrow$}}}
\def\TO{\ \mathbf{to}\ }
\def\SUBST#1#2{$\displaystyle #1 \leftarrow #2$}
\def\FUNC#1{\text{\textsc{#1}}}
\def\APP#1#2{#1\paren{#2}}
\def\VAR#1{\mathit{#1}}
\def\TRUE{\mathrm{true}}
\def\FALSE{\mathrm{false}}
\def\AND{\ \mathbf{and}\ }
\def\OR{\ \mathbf{or}\ }
\def\NOT{\mathbf{not}\ }
\def\RETURN#1{\gfnalg@tokenstyle{return}\ $\displaystyle #1$}
\def\CONSTR#1{\mathrm{#1}}
\def\TYPE#1{\mathit{#1}}
\def\RECORD#1{\{\gfnalg@record#1|\gfnalg@endofargument\}}
\def\gfnalg@record#1,#2|#3\gfnalg@endofargument{%
  \mathrm{#1}\!= #2%
  \ifx\gfnalg@unique#3\gfnalg@unique\else,\enskip \gfnalg@record#3\gfnalg@endofargument\fi
}
\def\DECRECORD#1#2{\gfnalg@tokenstyle{record}\ $#1 \defeq \{\gfnalg@decrecord#2|\gfnalg@endofargument\}$\par}
\def\gfnalg@decrecord#1,#2|#3\gfnalg@endofargument{%
  \mathrm{#1}: #2%
  \ifx\gfnalg@unique#3\gfnalg@unique\else,\enskip \gfnalg@decrecord#3\gfnalg@endofargument\fi
}
\def\DECVARIANT#1#2{\gfnalg@tokenstyle{variant}\ $#1 \defeq \gfnalg@decvariant#2|\gfnalg@endofargument$\par}
\def\gfnalg@decvariant#1,#2|#3\gfnalg@endofargument{
  \mathrm{#1}\ \text{\gfnalg@tokenstyle{of}}\ #2%
  \ifx\gfnalg@unique#3\gfnalg@unique\else\ {|}\ \gfnalg@decvariant#3\gfnalg@endofargument\fi
}
